services:
  webapp:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: tasvir-ai-webapp
    restart: unless-stopped
    env_file:
      - webapp/.env.production
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL:-http://localhost:8000}
      - NEXT_PUBLIC_BOT_USERNAME=${NEXT_PUBLIC_BOT_USERNAME:-your_bot_username}
    networks:
      - tasvir-network
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # Resource limits (optimized for 2 CPU / 4GB RAM server)
    deploy:
      resources:
        limits:
          cpus: '1.0'           # Max 1 CPU core
          memory: 1536M         # Max 1.5GB RAM
        reservations:
          cpus: '0.5'           # Min 0.5 CPU core
          memory: 512M          # Min 512MB RAM
    # Security settings
    security_opt:
      - no-new-privileges:true  # Prevent privilege escalation
    read_only: false            # Set to true if app doesn't write to filesystem
    # Logging limits (prevent disk fill)
    logging:
      driver: "json-file"
      options:
        max-size: "10m"         # Max 10MB per log file
        max-file: "3"           # Keep max 3 log files (30MB total)
        compress: "true"        # Compress old logs


networks:
  tasvir-network:
    driver: bridge
